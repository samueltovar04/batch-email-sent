services:
  mysql:
    image: mysql:8.0
    container_name: mysql_db
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: mydatabase
    volumes:
      - ./mysql-init-scripts:/docker-entrypoint-initdb.d/
      - ../mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ELASTIC_PASSWORD=changeme
      - xpack.security.enabled=true
    ports:
      - "9200:9200"
      - "9300:9300"

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.4
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      ELASTICSEARCH_USERNAME: elastic
      ELASTICSEARCH_PASSWORD: changeme
      ELASTICSEARCH_PRODUCT_CHECK: false
    depends_on:
      - elasticsearch

  quarkus-app:
    build:
      context: .
      dockerfile: src/main/docker/Dockerfile.native
    container_name: quarkus-app
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - elasticsearch
    environment:
      - QUARKUS_DATASOURCE_REACTIVE_URL=mysql://mysql:3306/mydatabase
      - QUARKUS_DATASOURCE_USERNAME=root
      - QUARKUS_DATASOURCE_PASSWORD=root
      - QUARKUS_MAILER_HOST=sandbox.smtp.mailtrap.io
      - QUARKUS_MAILER_PORT=2525
      - QUARKUS_MAILER_USERNAME=4a945ca4510d00
      - QUARKUS_MAILER_PASSWORD=9a26336182c830
      - QUARKUS_MAILER_FROM=no-reply@blackfincorp.com
      - QUARKUS_MAILER_TLS=false
      - QUARKUS_MAILER_SSL=false
      - QUARKUS_MAILER_STARTTLS=false
      - QUARKUS_MAILER_MOCK=false
      - QUARKUS_LOGGING_HANDLER_ELASTICSEARCH_HOST=http://elasticsearch:9200